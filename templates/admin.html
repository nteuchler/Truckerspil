<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>

</head>
<body>
    <h1>Admin Panel</h1>

    <h2>Update Prices</h2>
    <form action="/admin" method="POST">
    <label for="city">Select City:</label>
    <select name="city" id="city" onchange="this.form.submit()">
        <option value="" disabled selected>Select a city</option>
        {% for city in cities %}
            <option value="{{ city }}" {% if city == selected_city %}selected{% endif %}>{{ city }}</option>
        {% endfor %}
    </select>
    </form>

    {% if selected_city %}
    <form action="/update_prices" method="POST">
        <input type="hidden" name="city" value="{{ selected_city }}">
        <h3>Prices in {{ selected_city }}</h3>
        <ul>
            {% for item, price in city_prices[selected_city].items() %}
                <li>
                    {{ item }}: 
                    <input type="number" name="{{ item }}" value="{{ price }}" required>
                </li>
            {% endfor %}
        </ul>
        <button type="submit">Update Prices</button>
    </form>
    {% else %}
        <p>Please select a city to view and update prices.</p>
    {% endif %}

    <h2>Send Breaking News</h2>
    <form action="/push_news" method="POST">
        <label for="news_message">Breaking News:</label>
        <textarea name="news_message" id="news_message" rows="4" cols="50"></textarea>
        <br>
        <button type="submit">Push News</button>
    </form>


    <h2>Open / Close Cities</h2>
<form action="/update_city_status" method="POST">
    <ul>
    {% for city in cities %}
        <li>
            <label>
                <input type="checkbox"
                       name="closed_cities"
                       value="{{ city }}"
                       {% if city in closed_cities %}checked{% endif %}>
                {{ city }}
            </label>
        </li>
    {% endfor %}
    </ul>
    <button type="submit">Apply</button>
</form>
<h2>Manage Players</h2>
<table>
  <tr>
    <th>Player</th>
    <th>Current&nbsp;‚Ç¨</th>
    <th>Give&nbsp;/&nbsp;Take (¬±)</th>
    <th>Rename to‚Ä¶</th>
    <th>Delete</th>
  </tr>

  {% for name, pdata in players.items() %}
  <tr>
    <td>{{ name }}</td>
    <td>{{ pdata.money }}</td>

    <!-- Change money -->
    <td>
      <form action="/adjust_money" method="POST" style="display:inline;">
        <input type="number" name="{{ name }}" value="0" style="width:6em;">
        <button type="submit">Apply</button>
      </form>
    </td>

    <!-- Rename -->
    <td>
      <form action="/rename_player" method="POST" style="display:inline;">
        <input type="hidden" name="old_name" value="{{ name }}">
        <input type="text"   name="new_name" placeholder="New name" style="width:8em;">
        <button type="submit">Rename</button>
      </form>
    </td>

    <!-- Delete -->
    <td>
      <form action="/delete_player" method="POST"
            style="display:inline;"
            onsubmit="return confirm('Delete {{ name }} permanently?');">
        <input type="hidden" name="delete_player_name" value="{{ name }}">
        <button type="submit">üóëÔ∏è</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>




<h2>Add Player</h2>
<form action="/add_player" method="POST">
    <input type="text" name="new_player_name" placeholder="New player name" required>
    <button type="submit">Add</button>
</form>

<h2>Players Money Over Time</h2>
<div id="moneyChartWrap" style="max-width:100%;min-height:320px;position:relative;">
  <canvas id="moneyChart" style="width:100%;height:320px;"></canvas>
</div>
<p id="moneyChartMsg" style="font-size:.9rem;color:#666;margin-top:.3rem;"></p>

<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script>
(function () {
  const msgEl   = document.getElementById('moneyChartMsg');
  const canvas  = document.getElementById('moneyChart');
  let chartRef  = null; // local (not window) reference

  const showMsg = (t) => { if (msgEl) msgEl.textContent = t || ''; };

  async function fetchSeries(hours = 1) {
    const res  = await fetch(`/money_series?hours=${hours}`, { cache: 'no-store' });
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} ‚Äì ${text.slice(0, 200)}`);
    try { return JSON.parse(text); }
    catch (e) { throw new Error(`JSON parse error: ${e.message}. Raw: ${text.slice(0, 200)}`); }
  }

  async function draw(hours = 1) {
    try {
      if (!canvas) { showMsg('Canvas not found.'); return; }

      // wait a tick in case Chart.js is still loading with defer
      if (!window.Chart) await new Promise(r => setTimeout(r, 50));
      if (!window.Chart) { showMsg('Chart.js did not load.'); return; }

      const data = await fetchSeries(hours);
      const players = Object.keys(data || {});
      if (!players.length) { showMsg('No players in response.'); return; }

      const first  = players[0];
      const labels = (data[first] || []).map(pt => pt[0]);
      if (!labels.length) { showMsg('No time-series points yet. Make a transaction.'); return; }

      const datasets = players.map((name, i) => ({
        label: name,
        data: (data[name] || []).map(pt => pt[1]),
        fill: false,
        borderColor: `hsl(${(i * 67) % 360}, 70%, 45%)`,
        pointRadius: 0,
        borderWidth: 2,
        tension: 0.15
      }));

      const ctx = canvas.getContext('2d');
      if (!ctx) { showMsg('Could not get 2D context.'); return; }

      // üîß Always recreate the chart to avoid "undefined labels" update issues
      if (chartRef) { chartRef.destroy(); chartRef = null; }

      chartRef = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: "Players' Balances (‚Ç¨)" },
            tooltip: { mode: 'nearest', intersect: false }
          },
          scales: {
            x: { ticks: { maxTicksLimit: 10 }, grid: { display: false } },
            y: { beginAtZero: true, grace: 5 }
          },
          animation: false
        }
      });

      showMsg('');
    } catch (err) {
      console.error(err);
      showMsg(`Chart error: ${err.message}`);
    }
  }

  const boot = () => { draw(1); setInterval(() => draw(1), 60000); };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>





<h2>Reset / New Game</h2>
<form action="/reset_game" method="POST"
      onsubmit="return confirm('Really reset the entire game? All progress is lost.');">
    <button type="submit">Reset Game</button>
</form>


<a href="/">Back to Game</a>
</body>
</html>
